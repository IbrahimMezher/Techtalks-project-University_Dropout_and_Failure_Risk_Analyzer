<!doctype html>
<html lang="en" data-theme="{{ current_user.theme_preference or 'light' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Instructor â€¢ Students</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">

  <style>
    .page{ max-width:1100px; margin: 28px auto; padding: 0 24px; }

    .row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .title{
      margin:0;
      font-size:26px;
      letter-spacing:-.5px;
    }

    .subtitle{
      margin:6px 0 0;
      color: var(--muted);
      font-weight:750;
    }

    .panel-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin: 16px 0;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .toolbar input[type="text"],
    .toolbar input[type="email"]{
      width: 280px;
    }

    .select{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.82);
      font-weight:700;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
      margin: 16px 0;
    }

    .metric-num{ font-size:30px; font-weight:950; margin-top:10px; letter-spacing:-.6px; }
    .k{ font-weight:900; color:var(--muted); font-size:13px; }

    .pill{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.65);
    }

    .table-card{ padding:0; }
    .table-head{
      padding:18px 20px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }

    .table-wrap{ overflow:auto; }
    .tbl{ width:100%; border-collapse: collapse; min-width: 980px; }
    .tbl th,.tbl td{
      padding: 14px 14px;
      border-bottom:1px solid rgba(15,23,42,.08);
      text-align:left;
    }
    .tbl th{
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color: var(--muted2);
    }

    .risk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.65);
    }
    .risk.low{ border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.10); color: var(--success); }
    .risk.med{ border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.10); color:#b45309; }
    .risk.high{ border-color: rgba(220,38,38,.22); background: rgba(220,38,38,.10); color: var(--danger); }

    .hint{
      margin: 10px 0 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 750;
    }

    .two-col{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }

    @media (max-width: 980px){
      .cards{ grid-template-columns: 1fr; }
      .toolbar input[type="text"],
      .toolbar input[type="email"]{ width: 100%; }
      .two-col{ grid-template-columns: 1fr; }
      .tbl{ min-width: 820px; }
    }
  </style>
</head>

<body>
  <div class="bg-grid"></div>
  <div class="bg-blob blob-1"></div>
  <div class="bg-blob blob-2"></div>

  <header class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <span class="brand-dot"></span>
        <span class="brand-name">Dropout Analyzer</span>
      </div>

      <nav class="nav">
        <a class="nav-item" href="{{ url_for('instructor.instructor_log') }}">Dashboard</a>
        <a class="nav-item active" href="{{ url_for('instructor.ins_students') }}">Students</a>
        <a class="nav-item" href="{{ url_for('instructor.reports') }}">Reports</a>
        <a class="nav-item" href="{{ url_for('instructor.settings') }}">Settings</a>
      </nav>
    </div>
  </header>

  <main class="page">

    <section class="row">
      <div>
        <h1 class="title">Students</h1>
        <p class="subtitle">Invite students by email, then monitor risk indicators.</p>
      </div>
    </section>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flashes" style="margin-bottom: 14px;">
          {% for category, message in messages %}
            <p class="flash {{ category }}">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="panel-grid two-col">

      <div class="card">
        <div class="card-header">
          <h1 style="margin:0 0 6px; font-size:18px;">Invite a Student</h1>
          <p class="subtext" style="margin:0;">
            Send a secure link. Student must log in with the invited email to accept.
          </p>
        </div>

        <form class="form" method="POST" action="{{ url_for('instructor.invite_student') }}">
          <div class="field">
            <label>Student Email</label>
            <input type="email" name="student_email" placeholder="student@email.com" required>
          </div>

          <div class="field">
            <label>Assign Course (optional)</label>
            <select class="select" name="course_id">
              <option value="">No course yet</option>
              {% for c in courses %}
                <option value="{{ c.id }}">{{ c.course_name }}</option>
              {% endfor %}
            </select>
            <p class="hint">If selected, enrollment is created when the student accepts the invite.</p>
          </div>

          <button class="btn btn-primary" type="submit">Send Invite</button>
        </form>
      </div>

      <div class="card">
        <div class="card-header">
          <h1 style="margin:0 0 6px; font-size:18px;">Search & Filter</h1>
          <p class="subtext" style="margin:0;">Find students quickly by name/email and risk.</p>
        </div>

        <form class="toolbar" method="GET" action="{{ url_for('instructor.ins_students') }}">
          <input type="text" name="q" placeholder="Search by name or email..." value="{{ q or '' }}">
          <select class="select" name="risk">
            <option value="" {% if not risk %}selected{% endif %}>All risks</option>
            <option value="low" {% if risk=='low' %}selected{% endif %}>Low</option>
            <option value="med" {% if risk=='med' %}selected{% endif %}>Medium</option>
            <option value="high" {% if risk=='high' %}selected{% endif %}>High</option>
          </select>

          <button class="btn btn-primary" type="submit" style="width:auto;">Apply</button>
          <a class="btn btn-ghost" href="{{ url_for('instructor.ins_students') }}" style="width:auto;">Reset</a>
        </form>

        <p class="hint">Tip: risk is computed from attendance_rate + current_grade per enrollment.</p>
      </div>

    </section>

    <section class="cards">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span class="k">Students</span>
          <span class="pill">Total</span>
        </div>
        <div class="metric-num">{{ totals.total_students }}</div>
        <div class="subtitle" style="font-size:13px;">Active students with enrollments.</div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span class="k">At Risk</span>
          <span class="pill" style="background:rgba(245,158,11,.10); border-color:rgba(245,158,11,.22); color:#b45309;">Medium</span>
        </div>
        <div class="metric-num">{{ totals.at_risk }}</div>
        <div class="subtitle" style="font-size:13px;">Monitor and check in.</div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span class="k">Critical</span>
          <span class="pill" style="background:rgba(220,38,38,.10); border-color:rgba(220,38,38,.22); color:var(--danger);">High</span>
        </div>
        <div class="metric-num">{{ totals.critical }}</div>
        <div class="subtitle" style="font-size:13px;">Urgent intervention.</div>
      </div>
    </section>

    <section class="card table-card">
      <div class="table-head">
        <div>
          <h2 style="margin:0; font-size:18px;">Student List</h2>
          <p class="subtitle" style="margin:6px 0 0; font-size:13px;">Per enrollment (course-level rows).</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="pill">Rows: {{ rows|length if rows else 0 }}</span>
        </div>
      </div>

      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>Student</th>
              <th>Email</th>
              <th>Course</th>
              <th>Attendance</th>
              <th>Grade</th>
              <th>Risk</th>
            </tr>
          </thead>
          <tbody>
            {% if rows and rows|length > 0 %}
              {% for r in rows %}
              <tr>
                <td><strong>{{ r.student_name }}</strong></td>
                <td>{{ r.email }}</td>
                <td>{{ r.course_name }}</td>
                <td>{{ "%.0f"|format(r.attendance_rate) }}%</td>
                <td>{{ "%.0f"|format(r.current_grade) }}%</td>
                <td><span class="risk {{ r.risk_class }}">{{ r.risk_label }}</span></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" style="padding:18px;" class="subtitle">No matching students found.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

  </main>
</body>
</html>